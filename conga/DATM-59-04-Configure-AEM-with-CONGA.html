
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2023-01-12
 Rendered using Reflow Maven Skin 1.1.0 (https://github.com/wcm-io/wcm-io-tooling/tree/develop/maven/skins/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

  <head>
    <meta charset="UTF-8" />
    <title>DATM-59-04 Configure AEM with CONGA | CONGA Training</title>

    <link rel="shortcut icon" href="https://wcm.io/images/favicon.ico">
    <link rel="apple-touch-icon" href="https://wcm.io/images/favicon-152.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="wcm.io Training - Training materials for wcm.io and subprojects." />
    <meta http-equiv="content-language" content="en" />

    <link href="https://training.wcm.io/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://training.wcm.io/css/docs.css" rel="stylesheet" />
    <link href="https://training.wcm.io/css/reflow-skin.css" rel="stylesheet" />
    <link href="https://training.wcm.io/css/highlightjs-style-github.min.css" rel="stylesheet" />

    <link href="https://training.wcm.io/css/lightbox.css" rel="stylesheet" />

    <link href="https://training.wcm.io/css/site.css" rel="stylesheet" />
    <link href="https://training.wcm.io/css/print.css" rel="stylesheet" media="print" />


  </head>

  <body class="page-datm-59-04-configure-aem-with-conga project-io.wcm.training.conga" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target="#top-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../..">wcm.io Training</a>
          <div class="nav-collapse collapse" id="top-nav-collapse">
            <ul class="nav pull-right">
              <li ><a href="http://github.com/wcm-io-training" title="GitHub project" class="externalLink">GitHub project</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Trainings <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li ><a href="../" title="CONGA">CONGA</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contribute <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li ><a href="https://wcm.io/contribute.html" title="Contribute" class="externalLink">Contribute</a></li>
                  <li ><a href="https://github.com/wcm-io-training" title="Issues" class="externalLink">Issues</a></li>
                  <li ><a href="https://wcm-io.atlassian.net/wiki/" title="Wiki" class="externalLink">Wiki</a></li>
                  <li ><a href="https://wcm.io/mailing-lists.html" title="Mailing Lists" class="externalLink">Mailing Lists</a></li>
                  <li ><a href="http://github.com/wcm-io-training" title="Fork on GitHub" class="externalLink">Fork on GitHub</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  <div class="container">

  <!-- Masthead
  ================================================== -->

  <header>
  <div class="jumbotron subhead">
    <div class="row" id="banner">
      <div class="span12">
        <div class="pull-left">
          <a href="../../" id="bannerLeft"><h1><img src="https://wcm.io/images/favicon-16@3x.png"/> wcm.io Training</h1></a>
          <p class="lead">Training materials for wcm.io and subprojects.</p>
        </div>
        <div class="pull-right">
        </div>
      </div>
    </div>
  </div>
    <div>
      <ul class="breadcrumb">
        <li><a href="../../" title="wcm.io Training">wcm.io Training</a></li>
        <li class="divider">/</li>
        <li><a href="index.html" title="CONGA Training">CONGA Training</a></li>
        <li class="divider">/</li>
        <li>DATM-59-04 Configure AEM with CONGA</li>
      </ul>
    </div>
  </header>

  <div class="main-body">
  <div class="row">
    <div class="span8">
      <div class="body-content">
<section> 
 <div class="page-header">
  <h2 id="DATM-59-04_Configure_AEM_with_CONGA">DATM-59-04 Configure AEM with CONGA</h2>
 </div> 
 <section> 
  <h3 id="Overview">Overview</h3> 
  <ul> 
   <li>Configure AEM OSGi configuration</li> 
   <li>Deploy additional AEM packages</li> 
   <li>Generate configuration content packages</li> 
  </ul> 
 </section> 
 <section> 
  <h3 id="Git_project">Git project</h3> 
  <ul> 
   <li><a class="externalLink" href="https://github.com/wcm-io-training/training-conga-exercise-aem">https://github.com/wcm-io-training/training-conga-exercise-aem</a></li> 
  </ul> 
 </section> 
 <section> 
  <h3 id="Introduction">Introduction</h3> 
  <p>The GIT project contains CONGA configuration definitions and two CONGA example environments:</p> 
  <ul> 
   <li><code>definition/src/main/dev-environments/development.yaml</code></li> 
   <li><code>environment/src/main/environments/prod.yaml</code></li> 
  </ul> 
  <p>The first one is used for testing in the local AEM instance. You will only touch this for this exercise.</p> 
  <p>The second one is an example for a PROD environment - it is not used in the exercise, but you can have a look what different configuration is generated for the different environment files.</p> 
  <p>Please not that typically the configuration definition is part of the application Maven module structure and released together with it. For the sake of simplicity no AEM application is included in this training repository, instead the application packages from the <a class="externalLink" href="https://wcm.io/samples/">wcm.io Sample Application</a> are used, which are available on Maven Central. The wcm.io Sample Application itself also contains a CONGA configuration definition, but this is not used in this exercise.</p> 
 </section> 
 <section> 
  <h3 id="Exercise">Exercise</h3> 
  <section> 
   <h4 id="A.29_Deploy_the_sample_application_and_predefined_configuration">A) Deploy the sample application and predefined configuration</h4> 
   <p>Exercise:</p> 
   <ol style="list-style-type: decimal"> 
    <li>Execute <code>mvn clean install</code> on the root of the training repository</li> 
    <li>Deploy the application and configuration to your local AEM instance via the script <code>definition/packages-upload.sh</code> 
     <ul> 
      <li>This Script uses the <a class="externalLink" href="https://devops.wcm.io/conga/plugins/aem/">CONGA AEM Maven Plugin</a> to deploy the generated AEM packages to your local AEM instance running at port 4502</li> 
     </ul> </li> 
   </ol> 
   <p>Validation:</p> 
   <ul> 
    <li>Open the sample application at <a class="externalLink" href="http://localhost:4502/editor.html/content/wcm-io-samples/en.html">http://localhost:4502/editor.html/content/wcm-io-samples/en.html</a></li> 
    <li>Have a look at the generated configuration at 
     <ul> 
      <li><code>definition/target/configuration/development</code></li> 
      <li><code>environment/target/configuration/prod</code></li> 
     </ul> </li> 
   </ul> 
  </section> 
  <section> 
   <h4 id="B.29_Deploy_Groovy_Console_on_Author">B) Deploy Groovy Console on Author</h4> 
   <p>Exercise:</p> 
   <ol style="list-style-type: decimal"> 
    <li>There is a nice Open Source tool for AEM, the “AEM Groovy Console”: <a class="externalLink" href="https://github.com/CID15/aem-groovy-console">https://github.com/CID15/aem-groovy-console</a></li> 
    <li>The AEM ZIP package for deploying it is also available on Maven Central: <a class="externalLink" href="https://repo1.maven.org/maven2/org/cid15/aem/groovy/console/aem-groovy-console-all/17.0.0/">https://repo1.maven.org/maven2/org/cid15/aem/groovy/console/aem-groovy-console-all/17.0.0/</a></li> 
    <li>Please extend the role <code>wcm-io-samples-cms</code> to include a deployment of this Groovy Console Package</li> 
    <li>Make the deployment of this file conditional using a configuration parameter, similar as it is already done for the sample content in the same role</li> 
    <li>Deploy the Groovy Console only for the author node of the local environment <code>development.yaml</code></li> 
    <li>Redeploy the application and configuration to your local AEM instance</li> 
   </ol> 
   <p>Validation:</p> 
   <ul> 
    <li>Open <a class="externalLink" href="http://localhost:4502/apps/groovyconsole.html">http://localhost:4502/apps/groovyconsole.html</a> - the Groovy Console should be displayed</li> 
   </ul> 
  </section> 
  <section> 
   <h4 id="C.29_Restrict_Access_to_Groovy_Console_to_Administrators">C) Restrict Access to Groovy Console to Administrators</h4> 
   <p>Preparation - create two new users:</p> 
   <ul> 
    <li>Create a new non-admin user “author” with password “author” at <a class="externalLink" href="http://localhost:4502/security/users.html">http://localhost:4502/security/users.html</a> 
     <ul> 
      <li>Assign this user to group “Authors” (content-authors)</li> 
     </ul> </li> 
   </ul> 
   <p>Exercise:</p> 
   <ol style="list-style-type: decimal"> 
    <li>If you look in <a class="externalLink" href="http://localhost:4502/system/console/configMgr">http://localhost:4502/system/console/configMgr</a> you will find a configuration “Groovy Console Configuration Service” which has a configuration parameter labeled with “Allowed Groups” - we want to set this to <code>administrators</code> to restrict the access to the Groovy console</li> 
    <li>Enhance the role <code>wcm-io-samples-cms</code> to generate an additional OSGi configuration for this service that reconfigures this property to the desired value</li> 
    <li>Redeploy the application and configuration to your local AEM instance</li> 
   </ol> 
   <p>Validation:</p> 
   <ul> 
    <li>Log into AEM using the author user</li> 
    <li>Open the Groovy Console <a class="externalLink" href="http://localhost:4502/apps/groovyconsole.html">http://localhost:4502/apps/groovyconsole.html</a></li> 
    <li>Try to execute this script:</li> 
   </ul> 
   <div class="source"> 
    <pre><code>def templates = [] as TreeSet
 
getPage("/content/wcm-io-samples/en").recurse { page -&gt;
    def template = page?.template?.path
 
    if (template) {
        templates.add(template)
    }
}
 
templates.each {
    println it
}
</code></pre> 
   </div> 
   <ul> 
    <li>Log into AEM using the admin user</li> 
    <li>Open the Groovy Console <a class="externalLink" href="http://localhost:4502/apps/groovyconsole.html">http://localhost:4502/apps/groovyconsole.html</a></li> 
    <li>Try to execute the sample from above</li> 
   </ul> 
  </section> 
  <section> 
   <h4 id="D.29_Add_additional_logfile_for_JCR_Query_Debugging">D) Add additional logfile for JCR Query Debugging</h4> 
   <p>Exercise:</p> 
   <ol style="list-style-type: decimal"> 
    <li>We want to debug JCR queries by setting DEBUG log level for these two log categories: 
     <ul> 
      <li><code>org.apache.jackrabbit.oak.query</code></li> 
      <li><code>org.apache.jackrabbit.oak.plugins.index</code></li> 
     </ul> </li> 
    <li>In the role <code>wcm-io-samples-cms</code> you will find examples for defining additional loggers for the factory PID <code>org.apache.sling.commons.log.LogManager.factory</code></li> 
    <li>Create a new entry with the mentioned log categories, DEBUG log level, and a log file named <code>logs/query.log</code></li> 
    <li>Redeploy the application and configuration to your local AEM instance</li> 
   </ol> 
   <p>Validation:</p> 
   <ul> 
    <li>Ensure a <code>query.log</code> exists in the local AEM directory <code>crx-quickstart/logs</code></li> 
    <li>Execute any query in AEM or CRXDE Lite an ensure new log entries are written in this log (please note that several AEM background services also execute queries form time to time, so you will see a log of other messages as well)</li> 
   </ul> 
  </section> 
  <section> 
   <h4 id="E.29_Make_the_languages_displayed_in_AEM_translator_configurable">E) Make the languages displayed in AEM translator configurable</h4> 
   <p>Exercise:</p> 
   <ol style="list-style-type: decimal"> 
    <li>AEM comes with a translator tool for managing i18n dictionaries: <a class="externalLink" href="http://localhost:4502/libs/cq/i18n/translator.html">http://localhost:4502/libs/cq/i18n/translator.html</a></li> 
    <li>By default it displays all languages. But as described <a class="externalLink" href="https://docs.adobe.com/docs/en/aem/6-2/develop/components/i18n/translator.html#Changing%20Languages%20Listed%20in%20the%20Dictionary%20Table">here</a> it is also possible to configure the list of languages displayed in the translator</li> 
   </ol> 
   <ul> 
    <li>This is possible by creating a node at <code>/etc/languages</code>, node type <code>nt:unstructured</code>, and set a property <code>languages</code> to list of language codes e.g. de,fr,es</li> 
   </ul> 
   <ol style="list-style-type: decimal"> 
    <li>Generate an AEM package via CONGA automatically that creates this node and multivalued string property</li> 
    <li>Add a new configuration parameter to the role <code>wcm-io-samples-cms</code> which contains a list of language codes. Set it to the default value “de”, “en” in the role.</li> 
    <li>Generate a new AEM package from the role <code>wcm-io-samples-cms</code> based on a Handlebars JSON template. This JSON file defines the content of the langages node. Use Handlebars logic to fill in the language codes defined in the configuration parameter. Use the <code>aem-contentpackage</code> post processor to transform the generated JSON to an AEM package.</li> 
    <li>You can have a look at the file <code>wcm-io-samples-aem-cms-author-systemusers</code> generated by the same role as example - it uses the same mechanisms but is more complex.</li> 
    <li>Configure the list of languages for all nodes to “de”, “en”, “fr”, “it” in the environment <code>development.yaml</code></li> 
    <li>Redeploy the application and configuration to your local AEM instance</li> 
   </ol> 
   <p>Validation:</p> 
   <ul> 
    <li>Open <a class="externalLink" href="http://localhost:4502/libs/cq/i18n/translator.html">http://localhost:4502/libs/cq/i18n/translator.html</a> - you should see for columns with translations labelled DE, EN, FR, IT</li> 
   </ul> 
  </section> 
  <section> 
   <h4 id="F.29_Add_ACLs_for_translator_language_configuration">F) Add ACLs for translator language configuration</h4> 
   <p>Exercise:</p> 
   <ol style="list-style-type: decimal"> 
    <li>Currently, the updated list of languages in the Translator <a class="externalLink" href="http://localhost:4502/libs/cq/i18n/translator.html">http://localhost:4502/libs/cq/i18n/translator.html</a> is only visible for admin users - to fix this we need to add proper ACLs to the node to make it visible for other users as well</li> 
    <li>In the JSON file describing the content of the node add a policy node like this (it applies <code>read</code> privilege to the build-in group <code>content-authors</code>):</li> 
   </ol> 
   <div class="source"> 
    <pre><code class="language-json">    "rep:policy": {
      "jcr:primaryType": "rep:ACL",
      "allow": {
        "jcr:primaryType": "rep:GrantACE",
        "rep:principalName": "content-authors",
        "rep:privileges": [
          "jcr:read"
        ]
      }   
    }
</code></pre> 
   </div> 
   <ol style="list-style-type: decimal"> 
    <li>Within the role file you have also set the “Access Control Handling” to “merge” mode for this content package to get the ACL applied - look up the property name in the documentation: <a class="externalLink" href="https://devops.wcm.io/conga/plugins/aem/extensions.html">https://devops.wcm.io/conga/plugins/aem/extensions.html</a></li> 
    <li>Redeploy the application and configuration to your local AEM instance</li> 
   </ol> 
   <p>Validation:</p> 
   <ul> 
    <li>Log into AEM using the author user (created in step D)</li> 
    <li>Open <a class="externalLink" href="http://localhost:4502/libs/cq/i18n/translator.html">http://localhost:4502/libs/cq/i18n/translator.html</a> - you should see for columns with translations labelled DE, EN, FR, IT</li> 
   </ul> 
  </section> 
 </section> 
</section>
      </div>
    </div>
    <div class="span4">
      <div id="toc-sidebar">
        <div class="well">
          <ul class="nav nav-list">
            <li class="nav-header">Table of Contents</li>
    <li class="dropdown"><a href="#DATM-59-04_Configure_AEM_with_CONGA" title="DATM-59-04 Configure AEM with CONGA">DATM-59-04 Configure AEM with CONGA <b class="caret"></b></a>
      <ul class="nav nav-list">
    <li><a href="#Overview" title="Overview">Overview</a>
    <li><a href="#Git_project" title="Git project">Git project</a>
    <li><a href="#Introduction" title="Introduction">Introduction</a>
    <li class="dropdown"><a href="#Exercise" title="Exercise">Exercise <b class="caret"></b></a>
      <ul class="nav nav-list">
    <li><a href="#A.29_Deploy_the_sample_application_and_predefined_configuration" title="A) Deploy the sample application and predefined configuration">A) Deploy the sample application and predefined configuration</a>
    <li><a href="#B.29_Deploy_Groovy_Console_on_Author" title="B) Deploy Groovy Console on Author">B) Deploy Groovy Console on Author</a>
    <li><a href="#C.29_Restrict_Access_to_Groovy_Console_to_Administrators" title="C) Restrict Access to Groovy Console to Administrators">C) Restrict Access to Groovy Console to Administrators</a>
    <li><a href="#D.29_Add_additional_logfile_for_JCR_Query_Debugging" title="D) Add additional logfile for JCR Query Debugging">D) Add additional logfile for JCR Query Debugging</a>
    <li><a href="#E.29_Make_the_languages_displayed_in_AEM_translator_configurable" title="E) Make the languages displayed in AEM translator configurable">E) Make the languages displayed in AEM translator configurable</a>
    <li><a href="#F.29_Add_ACLs_for_translator_language_configuration" title="F) Add ACLs for translator language configuration">F) Add ACLs for translator language configuration</a>
        <li class="divider"></li>
      </ul>
    </li>
      </ul>
    </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  </div>

  </div>

  <!-- Footer
  ================================================== -->
  <footer class="well">
    <div class="container">
      <div class="row">
        <div class="span2 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Main</li>
            <li >
              <a href="../../" title="Home">Home</a>
            </li>
            <li >
              <a href="https://wcm.io/platforms.html" title="Platforms" class="externalLink">Platforms</a>
            </li>
            <li >
              <a href="https://wcm.io/maven.html" title="Maven Repositories" class="externalLink">Maven Repositories</a>
            </li>
            <li >
              <a href="http://github.com/wcm-io-training" title="GitHub project" class="externalLink">GitHub project</a>
            </li>
            <li >
              <a href="https://wcm.io/subprojects.html" title="Subprojects" class="externalLink">Subprojects</a>
            </li>
            <li >
              <a href="http://www.apache.org/licenses/LICENSE-2.0.txt" title="License" class="externalLink">License</a>
            </li>
            <li >
              <a href="https://wcm.io/commercial-support.html" title="Commercial Support" class="externalLink">Commercial Support</a>
            </li>
            <li >
              <a href="https://diva-e.com/en/imprint/" title="Imprint" class="externalLink">Imprint</a>
            </li>
            <li >
              <a href="https://wcm.io/privacy.html" title="Privacy Policy" class="externalLink">Privacy Policy</a>
            </li>
          </ul>
        </div>
        <div class="span2 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Trainings</li>
            <li >
              <a href="../" title="CONGA">CONGA</a>
            </li>
          </ul>
        </div>
        <div class="span2 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Contribute</li>
            <li >
              <a href="https://wcm.io/contribute.html" title="Contribute" class="externalLink">Contribute</a>
            </li>
            <li >
              <a href="https://github.com/wcm-io-training" title="Issues" class="externalLink">Issues</a>
            </li>
            <li >
              <a href="https://wcm-io.atlassian.net/wiki/" title="Wiki" class="externalLink">Wiki</a>
            </li>
            <li >
              <a href="https://wcm.io/mailing-lists.html" title="Mailing Lists" class="externalLink">Mailing Lists</a>
            </li>
            <li >
              <a href="http://github.com/wcm-io-training" title="Fork on GitHub" class="externalLink">Fork on GitHub</a>
            </li>
          </ul>
        </div>
        <div class="span3 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Maven documentation</li>
            <li >
              <a href="project-info.html" title="Project Information">Project Information <i class="icon-chevron-right"></i></a>
            </li>
          </ul>
        </div>
        <div class="span3 bottom-description">
          <blockquote>wcm.io Training provides Training materials for wcm.io and subprojects.</blockquote>
        </div>
      </div>
    </div>
  </footer>

  <div class="container subfooter">
    <div class="row">
      <div class="span12">
        <p class="pull-right"><a href="#">Back to top</a></p>
        <p class="copyright">Copyright &copy;2017-2023 <a href="https://training.wcm.io">wcm.io Training</a>. All Rights Reserved.</p>
        <p class="version-date"><span class="projectVersion">Version: 1. </span><span class="publishDate">Last Published: 2023-01-12. </span></p>
      </div>
    </div>
  </div>

  <!-- JavaScript
  ================================================== -->
  <script src="https://training.wcm.io/js/jquery.min.js"></script>
  <script src="https://training.wcm.io/js/bootstrap.min.js"></script>
  <script src="https://training.wcm.io/js/lightbox.min.js"></script>
  <script src="https://training.wcm.io/js/reflow-scroll.js"></script>
  <script src="https://training.wcm.io/js/highlight.min.js"></script>


  <script src="https://training.wcm.io/js/reflow-skin.js"></script>

  </body>
</html>